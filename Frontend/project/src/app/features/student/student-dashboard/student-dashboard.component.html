<div class="dashboard-container">
  <nav class="navbar">
    <div class="navbar-brand">
      <h1>University Portal</h1>
      <span class="user-badge">Student</span>
    </div>
    <div class="navbar-user">
      <span>Welcome, {{ studentName }}</span>
      <button class="btn-logout" (click)="logout()">Logout</button>
    </div>
  </nav>

  <div class="dashboard-content" *ngIf="!loading">
    <div class="tabs">
      <button
        [class.active]="activeTab === 'enrollments'"
        (click)="activeTab = 'enrollments'"
      >
        My Subjects
      </button>
      <button
        [class.active]="activeTab === 'grades'"
        (click)="activeTab = 'grades'"
      >
        My Grades
      </button>
      <button
        [class.active]="activeTab === 'subjects'"
        (click)="activeTab = 'subjects'"
      >
        Available Subjects
      </button>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'enrollments'">
      <h2>My Enrolled Subjects</h2>
      <div class="card-grid" *ngIf="enrollments.length > 0">
        <div class="card" *ngFor="let enrollment of enrollments">
          <div class="card-header">
            <h3>{{ enrollment.subject.title }}</h3>
            <span [class]="getStatusClass(enrollment.status)" class="status-badge">
              {{ enrollment.status }}
            </span>
          </div>
          <div class="card-body">
            <p><strong>Academic Year:</strong> {{ enrollment.subject.academic_year }}</p>
            <p><strong>Description:</strong> {{ enrollment.subject.description }}</p>
            <p><strong>Enrolled:</strong> {{ enrollment.enrolled_at | date:'short' }}</p>
            <p><strong>Attendance:</strong> {{ enrollment.attendance_percentage }}%</p>
            <div class="attendance-warning"
     *ngIf="(enrollment.attendance_percentage ?? 0) < 75 && enrollment.status === 'attending'">
  Warning: You need 75% attendance to take the exam
</div>

    <div class="grade-summary" *ngIf="enrollment.status === 'completed'">
  <ng-container *ngIf="gradeByEnrollmentId.get(enrollment.id) as g; else noGradeYet">
    <p><strong>Grade:</strong> <span class="grade-badge">{{ g.officialGrade }}</span></p>
    <p><strong>Final score:</strong> {{ g.totalScore }}</p>
    <p><strong>Assigned:</strong> {{ g.assignedAt | date:'short' }}</p>
  </ng-container>

  <ng-template #noGradeYet>
    <p><strong>Grade:</strong> Not assigned yet.</p>
  </ng-template>
</div>



          </div>
          <div class="card-footer" *ngIf="enrollment.status === 'attending'">
            <button class="btn-danger" (click)="dropSubject(enrollment.id)">Drop Subject</button>
          </div>
        </div>
      </div>
      <div class="empty-state" *ngIf="enrollments.length === 0">
        <p>You are not enrolled in any subjects yet.</p>
        <button class="btn-primary" (click)="activeTab = 'subjects'">Browse Available Subjects</button>
      </div>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'grades'">
      <h2>My Grades</h2>
      <div class="table-container" *ngIf="grades.length > 0">
        <table>
          <thead>
            <tr>
              <th>Subject</th>
              <th>Grade</th>
              <th>Final Score</th>
              <th>Professor</th>
              <th>Date Assigned</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let grade of grades">
              <td>{{ grade.subject_name }}</td>
              <td>
                <span class="grade-badge">{{ grade.grade_value }}</span>
              </td>
              <td>{{ grade.final_score }}</td>
              <td>{{ grade.professor_name }}</td>
              <td>{{ grade.assigned_date | date:'short' }}</td>
              <td>
                <button
                  class="btn-sm btn-warning"
                  *ngIf="grade.can_request_annulment"
                  (click)="requestAnnulment(grade.id)"
                >
                  Request Annulment
                </button>
                <span class="annulment-status" *ngIf="grade.annulment_requested">
                  Annulment Requested
                </span>
                <span class="annulment-status" *ngIf="!grade.can_request_annulment && !grade.annulment_requested">
                  -
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="empty-state" *ngIf="grades.length === 0">
        <p>No grades assigned yet.</p>
      </div>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'subjects'">
      <h2>Available Subjects</h2>
      <div class="card-grid" *ngIf="availableSubjects.length > 0">
        <div class="card" *ngFor="let subject of availableSubjects">
          <div class="card-header">
            <h3>{{ subject.title }}</h3>
          </div>
          <div class="card-body">
            <p><strong>Academic Year:</strong> {{ subject.academic_year }}</p>
            <p><strong>Professor:</strong> {{ subject.professor_name }}</p>
            <p><strong>Description:</strong> {{ subject.description }}</p>
          </div>
          <div class="card-footer">
            <button class="btn-primary" (click)="enrollInSubject(subject.id)">Enroll</button>
          </div>
        </div>
      </div>
      <div class="empty-state" *ngIf="availableSubjects.length === 0">
        <p>No available subjects at the moment.</p>
      </div>
    </div>
  </div>

  <div class="loading-state" *ngIf="loading">
    <p>Loading...</p>
  </div>
</div>
